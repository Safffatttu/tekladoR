<!DOCTYPE html>
<html>

<head>
	<style>
		th,
		td {
			border: 1px solid black;
		}
	</style>

	<script>
		function uploadSettings() {
			var xhr = new XMLHttpRequest();
			xhr.open("POST", "/setsettings", true);
			xhr.setRequestHeader('Content-Type', 'application/json');

			let settings = {};

			settings.deviceTopic = document.getElementById("deviceTopicInput").value;
			settings.wifi_ssid = document.getElementById("wifi_ssidInput").value;
			settings.wifi_password = document.getElementById("wifi_passwordInput").value;
			settings.mqtt_host = document.getElementById("mqtt_hostInput").value;
			settings.mqtt_port = document.getElementById("mqtt_portInput").value;

			let settingText = JSON.stringify(settings);
			xhr.send(settingText);
		};

		function uploadIoConfig() {
			var xhr = new XMLHttpRequest();
			xhr.open("POST", "/setioconfig", true);
			xhr.setRequestHeader('Content-Type', 'application/json');
			let configText = document.getElementById("ioText").value;

			try {
				JSON.parse(configText);
			} catch (error) {
				alert("Could not parse io config");
				return;
			}

			xhr.send(configText);
		};

		// let exampleJson = '{"ports": [{"pin": "5","type": "0"},{"pin": "4","type": "1"}],"pairs": [{"name": "string","mode": 0,"inputPorts": [0],"outputPorts": [1]}]}';
		// document.getElementById("ioText").value = exampleJson;
		// let ob = JSON.parse(exampleJson);

		function setIoTable(config) {
			let portsTable = document.getElementById("portsTable");

			const ports = config.ports;
			const pairs = config.pairs;

			for (let i = 0; i < ports.length; i++) {
				const port = ports[i];

				let row = portsTable.insertRow();
				let cell = row.insertCell();
				cell.textContent = i;

				cell = row.insertCell();
				cell.textContent = port.pin;

				cell = row.insertCell();
				cell.textContent = port.type ? "output" : "intput";
			};

			let pairsTable = document.getElementById("pairsTable");

			pairs.forEach(pair => {
				let row = pairsTable.insertRow();

				let cell = row.insertCell();
				cell.textContent = pair.name;

				cell = row.insertCell();
				cell.textContent = pair.mode ? "Momentary" : "Bistable ";

				let inputPortsSelect = document.createElement("select");
				inputPortsSelect.multiple = true;

				let outputPortsSelect = document.createElement("select");
				outputPortsSelect.multiple = true;

				for (let i = 0; i < ports.length; i++) {
					const port = ports[i];
					let option = document.createElement("option");
					option.text = port.pin;

					if (port.type == 0) {
						inputPortsSelect.appendChild(option);
					} else if (port.type == 1) {
						outputPortsSelect.appendChild(option);
					}
				}
				cell = row.insertCell();
				cell.appendChild(inputPortsSelect);

				cell = row.insertCell();
				cell.appendChild(outputPortsSelect);
			});

		}

		function loadConfiguration() {
			var ioConfigReq = new XMLHttpRequest();
			ioConfigReq.open("GET", "/getioconfig", true);
			ioConfigReq.onreadystatechange = function () {
				if (ioConfigReq.readyState == 4 && ioConfigReq.status == 200) {
					document.getElementById("ioText").value = ioConfigReq.responseText
					setIoTable(JSON.parse(ioConfigReq.responseText));
				}
			};
			ioConfigReq.send(null);

			// setIoTable(ob);

			var settingsConfigReq = new XMLHttpRequest();
			settingsConfigReq.open("GET", "/getsettings", true);
			settingsConfigReq.onreadystatechange = function () {
				if (settingsConfigReq.readyState == 4 && settingsConfigReq.status == 200) {
					let data = JSON.parse(settingsConfigReq.responseText);

					document.getElementById("deviceTopicInput").value = data.deviceTopic;
					document.getElementById("wifi_ssidInput").value = data.wifi_ssid;
					document.getElementById("wifi_passwordInput").value = data.wifi_password;
					document.getElementById("mqtt_hostInput").value = data.mqtt_host;
					document.getElementById("mqtt_portInput").value = data.mqtt_port;
				}
			};
			settingsConfigReq.send(null);

			var serialNumReq = new XMLHttpRequest();
			serialNumReq.open("GET", "/getserialnum", true);
			serialNumReq.onreadystatechange = function () {
				if (serialNumReq.readyState == 4 && serialNumReq.status == 200) {
					document.getElementById("serialNum").textContent = serialNumReq.responseText;
				}
			};
			serialNumReq.send(null);
		};

	</script>
</head>

<body onload="loadConfiguration()">
	<h1>TekladoR IO Module configurator</h1>
	Serial number: <span id="serialNum"></span>
	<br>

	<p>
		<label for="settingsText">Settings</label>

	<table>
		<tr>
			<td>deviceTopic</td>
			<td>
				<input type="text" id="deviceTopicInput">
			</td>
		</tr>
		<tr>
			<td>wifi_ssid</td>
			<td>
				<input type="text" id="wifi_ssidInput">
			</td>
		</tr>
		<tr>
			<td>wifi_password</td>
			<td>
				<input type="text" id="wifi_passwordInput">
			</td>
		</tr>
		<tr>
			<td>mqtt_host</td>
			<td>
				<input type="text" id="mqtt_hostInput">
			</td>
		</tr>
		<tr>
			<td>mqtt_port</td>
			<td>
				<input type="text" id="mqtt_portInput">
			</td>
		</tr>
	</table>

	<button onclick="uploadSettings()">Upload settings</button>
	</p>

	<label for="ioText">Io configuration</label>
	<br>
	<textarea id="ioText" name="IO configuration" rows="30" cols="80"></textarea>
	<br>
	<button onclick="uploadIoConfig()">Upload configuration</button>

	<p>
		Ports
	<table id="portsTable">
		<tr>
			<td>Port</td>
			<td>Type</td>
		</tr>
	</table>

	Pairs
	<table id="pairsTable">
		<tr>
			<td>Name</td>
			<td>Mode</td>
			<td>Inputs</td>
			<td>Outputs</td>
		</tr>
	</table>

	<br>
	<br>
	<br>

	<a href="https://github.com/Safffatttu/tekladoR">Documentation and source code</a>

</body>

</html>